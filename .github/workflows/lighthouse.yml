# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Run Lighthouse CI (Push on PR to master branch)

# ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ì¡°ê±´
on:
  pull_request:
    branches:
      # master ë¸Œëœì¹˜ê°€ íƒ€ê²Ÿë¸Œëœì¹˜ì¸ PR
      - master
    types:
      # PRì´ ìƒì„±ë˜ë©´
      - opened
      # PRì´ ì—…ë°ì´íŠ¸ë˜ë©´
      - synchronize

    # ì•¡ì„¸ìŠ¤ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pull-requests: write

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰í•  ì¼
jobs:
  lhci:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      # ì›Œí¬í”Œë¡œìš°ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜´
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js ë²„ì „ì„ ì„¤ì¹˜í•˜ê³  ì„¤ì •
      # ê°ìì˜ í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ëŠ” ë…¸ë“œ ë²„ì „ì„ ì‚¬ìš©í•˜ë©´ ë¨
      - name: Use Node.js 18.12.1
        uses: actions/setup-node@v4
        with:
          node-version: 18.12.1

      # node modules ë””ë ‰í† ë¦¬ ìºì‹±
      # ë™ì¼í•œ ì¢…ì†ì„±ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë˜ëŠ” ì›Œí¬í”Œë¡œìš° ì†ë„ í–¥ìƒì‹œí‚´
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          # ìºì‹œí•  ë””ë ‰í† ë¦¬/íŒŒì¼ì˜ ê²½ë¡œ ì§€ì •
          path: |
            **/node_modules
          # ìºì‹œ í‚¤ ì„¤ì •
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          # ìºì‹œë¥¼ ë³µì›í•  ë•Œ ì‚¬ìš©í•  ëŒ€ì²´ í‚¤ ì§€ì •
          restore-keys: |
            ${{ runner.os }}-node-

      # í”„ë¡œì íŠ¸ ì¢…ì†ì„± ì„¤ì¹˜
      # package.json íŒŒì¼ì— ì •ì˜ëœ ëª¨ë“  ì¢…ì†ì„±ì„ node_modules ë””ë ‰í† ë¦¬ì— ì„¤ì •
      - name: Install packages
        run: |
          npm install

      # í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build
        run: |
          npm run build

           # Desktop ì„¤ì •ìœ¼ë¡œ Lighthouse ì¸¡ì •
      - name: Run Lighthouse CI for Desktop
        # secretsì— ì €ì¥í•œ LHCI_GITHUB_APP_TOKEN ê°’ ì‚¬ìš©
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        # Lighthouse CIë¥¼ ì „ì—­ìœ¼ë¡œ ì„¤ì¹˜
        # lighthouserc-desktop.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ Lighthouse ë°ì´í„° ìˆ˜ì§‘
        # lighthouserc-desktop.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ ìˆ˜ì§‘ëœ ë°ì´í„° ì—…ë¡œë“œ
        # ì‹¤íŒ¨ ì‹œ 'Fail to Run Lighthouse CI ğŸ’¦' ì¶œë ¥
        run: |
          npm install -g @lhci/cli
          lhci collect --config=lighthouserc-desktop.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'
          lhci upload --config=lighthouserc-desktop.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'

      # Mobile ì„¤ì •ìœ¼ë¡œ Lighthouse ì¸¡ì •
      - name: Run Lighthouse CI for Mobile
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        # lighthouserc-mobile.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ Lighthouse ë°ì´í„° ìˆ˜ì§‘
        # lighthouserc-mobile.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ ìˆ˜ì§‘ëœ ë°ì´í„° ì—…ë¡œë“œ
        # ì‹¤íŒ¨ ì‹œ 'Fail to Run Lighthouse CI ğŸ’¦' ì¶œë ¥
        run: |
          lhci collect --config=lighthouserc-mobile.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'
          lhci upload --config=lighthouserc-mobile.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'
