name: pr-preview
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches: ['main', 'develop']

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  pages: write
  deployments: write

concurrency: preview-${{ github.ref }}

jobs:
  deploy-preview:
    runs-on: ubuntu-latest

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Get Vercel Environment Variables
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Install Dependencies and Build
        run: |
          npm install
          npm run build

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} > vercel-output.txt

          echo "ðŸ” Raw vercel-output.txt content:"
          cat vercel-output.txt

          preview_url=$(grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' vercel-output.txt)
          echo "ðŸ” Extracted preview_url: $preview_url"

          echo "preview_url=$preview_url" >> $GITHUB_OUTPUT

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          separator: '\n'

  deploy-gh-pages:
    needs: deploy-preview
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3

      - name: Generate comment body
        run: |
          {
            echo "ðŸŽ‰ êµ¬í˜„í•œ ê¸°ëŠ¥ Preview:"
            echo "- **Vercel**: ${{ needs.deploy-preview.outputs.preview_url }}"
            echo "- **GitHub Pages**: ${{ needs.deploy-gh-pages.outputs.page_url }}"
            echo ""
            echo "ðŸ§© ë³€ê²½ëœ íŒŒì¼"
            echo ""
            printf "%b\n" "${{ steps.changed-files.outputs.all_changed_files }}"
          } > comment.md

      - name: Comment PR with Preview URL and changed files
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: comment.md
